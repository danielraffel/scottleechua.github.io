<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>    <!-- Metadata, OpenGraph and Schema.org -->
        <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Self-hosting Ghost on Google Cloud Platform | Scott Lee Chua üáµüá≠</title>
    <meta name="author" content="Scott Lee Chua üáµüá≠" />
    <meta name="description" content="A plaintext walkthrough of deploying an almost-free, fully self-hosted blog using Ghost, Caddy, Cloudflare, Mailgun, and GCP." />

    <!-- OpenGraph -->
    <meta property="og:site_name" content="Scott Lee Chua üáµüá≠" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Self-hosting Ghost on Google Cloud Platform" />
    <meta property="og:url" content="https://scottleechua.com/blog/self-hosting-ghost-on-gcp/" />
    <meta property="og:description" content="A plaintext walkthrough of deploying an almost-free, fully self-hosted blog using Ghost, Caddy, Cloudflare, Mailgun, and GCP." />
    <meta property="og:image" content="https://scottleechua.com/assets/img/ghost-gcp-diagram.png" />
    <meta property="og:locale" content="en" />

    <!-- Twitter card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Self-hosting Ghost on Google Cloud Platform" />
    <meta name="twitter:description" content="A plaintext walkthrough of deploying an almost-free, fully self-hosted blog using Ghost, Caddy, Cloudflare, Mailgun, and GCP." />
    <meta name="twitter:image" content="https://scottleechua.com/assets/img/ghost-gcp-diagram.png" />
    


<!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

<!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

<!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light" />

<!-- Styles -->
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://scottleechua.com/blog/self-hosting-ghost-on-gcp/">

    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark" />

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    
  </head>

  <body class="sticky-bottom-footer">

    <!-- Header -->

    
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm sticky-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://scottleechua.com/">Scott Lee  Chua üáµüá≠</a>
          
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/comics/">comics</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/prose/">prose</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/puzzles/">puzzles</a>
              </li>
<!-- Blog -->
              
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              
<!--

              <!~~ Toggle theme mode ~~>
              <div class = "toggle-container">
                <a id = "light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
 -->
              
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->

    <div class="container mt-5">
      <!-- _layouts/post.html -->



<div class="post">

  <header class="post-header">
    <h1 class="post-title">Self-hosting Ghost on Google Cloud Platform</h1>
    <p class="post-meta">January 21, 2022</p>
  </header>

  <article class="post-content">
    <p><img class="img-fluid rounded" src="/assets/img/ghost-gcp-diagram.png" alt="A flowchart. Caddy 2 web server and ghost blog engine. A right directed arrow toward a grey box entitled google cloud platform. Inside the grey box, compute engine. Right directed arrow. Static IP address. Right directed arrow. Cloud flare content delivery network. From above the grey box, name cheap, domain registrar. Below directed arrow. Static IP address. From above cloud flare, mail provider mail gun. Below directed arrow. Cloud flare, content delivery network. Right directed arrow. Blog and newsletter."></p>

<p><a href="#overview">I‚Äôm sold on this stack, jump to the tutorial!</a></p>

<hr>

<h2 id="why-this-stack">Why this stack?</h2>

<p>I recently helped a friend migrate his movie review blog off <a href="https://support.wix.com/en/article/free-vs-premium-site" target="_blank" rel="noopener">Wix‚Äôs free tier</a> and onto a <a href="https://ghost.org/" target="_blank" rel="noopener">Ghost</a> blog self-hosted on <a href="https://cloud.google.com/" target="_blank" rel="noopener">Google Cloud Platform</a> (GCP). He was looking for</p>

<ol>
  <li>the ability to use a custom domain without an additional fee;</li>
  <li>a visual, rich-text content editor;</li>
  <li>a user-friendly website control panel accessible from mobile; and</li>
  <li>a plug-and-play email newsletter feature</li>
</ol>

<p><strong>for free, or as close to free as possible.</strong></p>

<p>Requirement (1) ruled out other ‚Äúas-a-service‚Äù website builders, while (2), (3), and (4) together ruled out my go-to <a href="https://jekyllrb.com/" target="_blank" rel="noopener">Jekyll</a> + <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> combo. In the end, I settled on the stack shown in the diagram above. A brief overview of why I chose each component:</p>

<ul>
  <li>
<strong>Blog engine.</strong> I chose <a href="https://ghost.org/" target="_blank" rel="noopener">Ghost</a> as it has a beautiful content editor and a mobile-friendly control panel. While Ghost (the company) offers managed hosting plans for a fee, Ghost (the blog engine) is open-source and free to self-host.</li>
  <li>
<strong>Web server.</strong> I chose <a href="https://caddyserver.com" target="_blank" rel="noopener">Caddy</a> as the web server instead of the default <a href="https://www.nginx.com/" target="_blank" rel="noopener">Nginx</a> because Caddy enforces HTTPS right out of the box. While it‚Äôs certainly possible to enforce HTTPS on Nginx <a href="https://www.nginx.com/blog/using-free-ssltls-certificates-from-lets-encrypt-with-nginx/" target="_blank" rel="noopener">using certbot and cron jobs</a>, Caddy abstracts away literally <a href="https://caddyserver.com/docs/automatic-https" target="_blank" rel="noopener">everything to do with HTTPS</a>, and I find it‚Äôs just that much easier to use.</li>
  <li>
<strong>Hosting server.</strong> I chose to use a <a href="https://cloud.google.com/compute" target="_blank" rel="noopener">Compute Engine</a> virtual machine to host the website, because GCP has a unique <a href="https://cloud.google.com/free/docs/gcp-free-tier/#compute" target="_blank" rel="noopener">Always Free Tier</a> (distinct from their free trial period) with resources enough to permanently host a small- to medium-sized blog (1GB RAM, 1GB monthly traffic to all regions except China and Australia). GCP usually charges for static external IP addresses, but these are also free when attached to Free Tier virtual machines.</li>
  <li>
<strong>Domain registrar.</strong> I like to buy my domain names through <a href="https://namecheap.com" target="_blank" rel="noopener">Namecheap</a> because they‚Äôre transparent with their prices and don‚Äôt fill your cart with upsells.</li>
  <li>
<strong>Content delivery network (CDN).</strong> I use <a href="https://cloudflare.com" target="_blank" rel="noopener">Cloudflare</a>‚Äôs free CDN service to shorten website loading times and protect against <a href="https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attack/" target="_blank" rel="noopener">DDOS</a> attacks. I also prefer managing DNS records through Cloudflare (rather than at the domain registrar level); not only is <a href="https://www.cloudflare.com/learning/dns/what-is-dns/" target="_blank" rel="noopener">domain resolution</a> faster, the user interface is also sleeker.</li>
  <li>
<strong>Mail provider.</strong> Ghost has a built-in newsletter feature that integrates most easily with <a href="https://mailgun.com" target="_blank" rel="noopener">Mailgun</a>. I‚Äôm not too familiar with mail providers, but Mailgun has been great so far, consistently sending emails to inbox, not spam. The first 1,250 emails every month are <a href="https://help.mailgun.com/hc/en-us/articles/360048661093-How-does-PAYG-billing-work" target="_blank" rel="noopener">free</a>, and 0.80 USD / thousand emails thereafter.</li>
</ul>

<p>I tried to come up with a tech stack that was <strong>as low-cost as a self-hosted website could possibly be.</strong> In the diagram above, the only cost for certain is the annual domain name rental fee; everything else is either totally free (Caddy, Ghost) or free with usage limits (GCP, Cloudflare, Mailgun).</p>

<h2 id="overview">Overview</h2>

<p>In this walkthrough, I outline the whole process of setting up <strong>each and every part</strong> of this exact stack, in five stages:</p>

<ol>
  <li><a href="#1-set-up-gcp">Set up GCP</a></li>
  <li><a href="#2-configure-the-domain">Configure the domain</a></li>
  <li><a href="#3-deploy-ghost-and-caddy">Deploy Ghost and Caddy</a></li>
  <li><a href="#4-configure-ghost">Configure Ghost</a></li>
  <li><a href="#5-finish-cloudflare-configuration">Finish Cloudflare configuration</a></li>
</ol>

<p>The whole thing takes 1-2 hours depending on your comfort level with the various technologies.</p>

<p><em>Note: To follow along with the configuration instructions below, edit the <code class="language-plaintext highlighter-rouge">highlighted values</code> and leave all other fields at default values.</em></p>

<h3 id="1-set-up-gcp">1. Set up GCP</h3>

<h4 id="initialize-gcp">Initialize GCP</h4>
<ol>
  <li>Log in to the Google account you want to use with GCP. Make a GCP account <a href="https://console.cloud.google.com" target="_blank" rel="noopener">here</a>.</li>
  <li>Select <code class="language-plaintext highlighter-rouge">Create Project</code>:
    <ul>
      <li>Project name: <code class="language-plaintext highlighter-rouge">ghost-blog</code>
</li>
      <li>Location: <code class="language-plaintext highlighter-rouge">No organization</code>
</li>
    </ul>
  </li>
  <li>In the floating topbar, <code class="language-plaintext highlighter-rouge">Activate</code> Free Trial. You‚Äôll be asked to set up a billing account and put your card details on file.</li>
  <li>
<em>(Optional)</em> In the floating topbar, <code class="language-plaintext highlighter-rouge">Activate</code> a paid account. I prefer to do this immediately for two reasons. One, everything you‚Äôve set up today will be deleted unless you remember to upgrade <em>before</em> the free trial ends; and two, the resources used (at least in this tutorial) should stay within the bounds of the Always Free tier anyway.</li>
  <li>Go to Billing &gt; Budgets &amp; alerts &gt; <code class="language-plaintext highlighter-rouge">Create Budget</code>:
    <ul>
      <li>Name: <code class="language-plaintext highlighter-rouge">ghost-blog-budget</code>
</li>
      <li>Time range: <code class="language-plaintext highlighter-rouge">Monthly</code>
</li>
      <li>Budget type: <code class="language-plaintext highlighter-rouge">Specified amount</code>
</li>
      <li>Target amount: <code class="language-plaintext highlighter-rouge">2.00</code> (as cost should be zero, anyway)</li>
      <li>Manage notifications: <code class="language-plaintext highlighter-rouge">Email alerts to billing admins and users</code>
</li>
    </ul>
  </li>
</ol>

<h4 id="initialize-compute-engine">Initialize Compute Engine</h4>
<ol>
  <li>Go to Compute Engine &gt; <code class="language-plaintext highlighter-rouge">Enable API</code>.</li>
  <li>
<em>(Optional)</em> If asked to <code class="language-plaintext highlighter-rouge">Create Credentials</code>, do so:
    <ul>
      <li>Data accessing: <code class="language-plaintext highlighter-rouge">Application Data</code>
</li>
      <li><code class="language-plaintext highlighter-rouge">Yes, I'm using Compute Engine</code></li>
    </ul>
  </li>
  <li>Go to Instance Templates &gt; <code class="language-plaintext highlighter-rouge">Create Instance Template</code>:
    <ul>
      <li>Name: <code class="language-plaintext highlighter-rouge">free-web-server</code>
</li>
      <li>Machine family: <code class="language-plaintext highlighter-rouge">General-purpose</code>
</li>
      <li>Series: <code class="language-plaintext highlighter-rouge">E2</code>
</li>
      <li>Machine type: <code class="language-plaintext highlighter-rouge">e2-micro (2vCPU, 1GB memory)</code>
</li>
      <li>Boot disk:
        <ul>
          <li>Operating system: <code class="language-plaintext highlighter-rouge">Ubuntu</code>
</li>
          <li>Version: <code class="language-plaintext highlighter-rouge">Ubuntu 20.04 LTS</code>
</li>
          <li>Boot disk type: <code class="language-plaintext highlighter-rouge">Standard persistent disk</code>
</li>
        </ul>
      </li>
      <li>Firewall:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">Allow HTTP traffic</code></li>
          <li><code class="language-plaintext highlighter-rouge">Allow HTTPS traffic</code></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Go to VM instances &gt; <code class="language-plaintext highlighter-rouge">Create an instance</code>:
    <ul>
      <li>New VM Instance from template: <code class="language-plaintext highlighter-rouge">free-web-server</code>
</li>
      <li>Name: <code class="language-plaintext highlighter-rouge">ghost-blog</code>
</li>
      <li>Region: <code class="language-plaintext highlighter-rouge">us-west1</code> (or any region on the <a href="https://cloud.google.com/free/docs/gcp-free-tier/#compute" target="_blank" rel="noopener">Always Free Tier</a>)</li>
      <li>Security:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">Turn on Secure Boot</code></li>
          <li><code class="language-plaintext highlighter-rouge">Turn on vTPM</code></li>
          <li><code class="language-plaintext highlighter-rouge">Turn on Integrity Monitoring</code></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Go to Snapshots &gt; <code class="language-plaintext highlighter-rouge">Create Snapshot Schedule</code>:
    <ul>
      <li>Name: <code class="language-plaintext highlighter-rouge">weekly-backup-schedule</code>
</li>
      <li>Schedule location: <code class="language-plaintext highlighter-rouge">us-west1</code> (the same region as your instance)</li>
      <li>Snapshot storage location: <code class="language-plaintext highlighter-rouge">Regional</code>
        <ul>
          <li>Location: <code class="language-plaintext highlighter-rouge">us-west1</code>
</li>
        </ul>
      </li>
      <li>Schedule frequency: <code class="language-plaintext highlighter-rouge">Weekly</code>
</li>
    </ul>
  </li>
  <li>Go to Disks &gt; <code class="language-plaintext highlighter-rouge">ghost-blog</code> &gt; <code class="language-plaintext highlighter-rouge">Edit</code>:
    <ul>
      <li>Snapshot schedule: <code class="language-plaintext highlighter-rouge">weekly-backup-schedule</code>
</li>
    </ul>
  </li>
</ol>

<h4 id="initialize-vpc-network">Initialize VPC Network</h4>
<ol>
  <li>Go to VPC network &gt; Firewall &gt; <code class="language-plaintext highlighter-rouge">Create Firewall Rule</code>:
    <ul>
      <li>Name: <code class="language-plaintext highlighter-rouge">allow-outgoing-2525</code>
</li>
      <li>Logs: <code class="language-plaintext highlighter-rouge">Off</code>
</li>
      <li>Direction: <code class="language-plaintext highlighter-rouge">Egress</code>
</li>
      <li>Action on match: <code class="language-plaintext highlighter-rouge">Allow</code>
</li>
      <li>Targets: <code class="language-plaintext highlighter-rouge">All instances in the network</code>
</li>
      <li>Destination filter:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">IPv4 ranges</code></li>
          <li>Destination ranges: <code class="language-plaintext highlighter-rouge">0.0.0.0/0</code>
</li>
        </ul>
      </li>
      <li>Protocols and ports:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">Specified protocols and ports</code></li>
          <li>
<code class="language-plaintext highlighter-rouge">tcp</code>: <code class="language-plaintext highlighter-rouge">2525</code>
</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Go to External IP addresses &gt; <code class="language-plaintext highlighter-rouge">Reserve Static Address</code>:
    <ul>
      <li>Name: <code class="language-plaintext highlighter-rouge">ghost-blog-ip</code>
</li>
      <li>Network service tier: <code class="language-plaintext highlighter-rouge">Standard</code>
</li>
      <li>Region: <code class="language-plaintext highlighter-rouge">us-west1</code> (the same region as your instance)</li>
      <li>Attached to: <code class="language-plaintext highlighter-rouge">ghost-blog</code>
</li>
    </ul>
  </li>
  <li>Take note of the External IP address.</li>
</ol>

<h3 id="2-configure-the-domain">2. Configure the domain</h3>

<h4 id="buy-a-domain-and-set-up-cloudflare">Buy a domain and set up Cloudflare</h4>
<ol>
  <li>Make a Namecheap account and buy your domain. I‚Äôll use <code class="language-plaintext highlighter-rouge">ghostblog.com</code> as an example. Going forward, everywhere you see <code class="language-plaintext highlighter-rouge">ghostblog.com</code>, replace it with your own domain name.</li>
  <li>Make a Cloudflare account and add your domain under the Free subscription plan.</li>
  <li>Under ‚ÄúReview your DNS records‚Äù, first <strong>delete all</strong> the records.</li>
  <li>
<code class="language-plaintext highlighter-rouge">Add record</code>:
    <ul>
      <li>Type: <code class="language-plaintext highlighter-rouge">A</code>
</li>
      <li>Name: <code class="language-plaintext highlighter-rouge">ghostblog.com</code>
</li>
      <li>IPv4 address: the static IP address you just reserved</li>
      <li>Proxy status: <code class="language-plaintext highlighter-rouge">DNS only</code>
</li>
    </ul>
  </li>
  <li>
<code class="language-plaintext highlighter-rouge">Save</code> &gt; <code class="language-plaintext highlighter-rouge">Continue</code> &gt; <code class="language-plaintext highlighter-rouge">Confirm</code>.</li>
  <li>Go back to Namecheap &gt; ghostblog.com &gt; <code class="language-plaintext highlighter-rouge">Manage</code> &gt; Nameservers &gt; <code class="language-plaintext highlighter-rouge">Custom DNS</code> and input the specified Cloudflare nameservers.</li>
  <li>Go back to Cloudflare &gt; <code class="language-plaintext highlighter-rouge">Done, check nameservers</code>.</li>
  <li>Go to Cloudflare &gt; ghostblog.com &gt; Overview, then in the right sidebar, Advanced Actions &gt; <code class="language-plaintext highlighter-rouge">Pause Cloudflare on site</code> while finishing setup.</li>
</ol>

<h4 id="set-up-mailgun">Set up Mailgun</h4>
<ol>
  <li>Make a Mailgun account under the <code class="language-plaintext highlighter-rouge">Foundation Trial</code> plan. You‚Äôll be asked to confirm a phone number and put your card details on file.</li>
  <li>Select <code class="language-plaintext highlighter-rouge">Add a custom domain</code>:
    <ul>
      <li>Domain name: <code class="language-plaintext highlighter-rouge">ghostblog.com</code>
</li>
      <li>Domain region: <code class="language-plaintext highlighter-rouge">US</code> (unless your website requires within-<code class="language-plaintext highlighter-rouge">EU</code> data processing)</li>
    </ul>
  </li>
  <li>Go back to Cloudflare &gt; ghostblog.com &gt; DNS and add the five DNS records Mailgun requires. Turn Proxy Status off (i.e., set to <code class="language-plaintext highlighter-rouge">DNS only</code>).</li>
  <li>Go back to Mailgun &gt; <code class="language-plaintext highlighter-rouge">Verify DNS settings</code>.</li>
  <li>Once the custom domain has been added to Mailgun, go to Sending &gt; Domain Settings &gt; SMTP Credentials. Take note of the ‚Äúlogin‚Äù (usually <code class="language-plaintext highlighter-rouge">postmaster@ghostblog.com</code>).</li>
  <li>Click <code class="language-plaintext highlighter-rouge">Reset password</code> &gt; <code class="language-plaintext highlighter-rouge">Reset password</code> &gt; <code class="language-plaintext highlighter-rouge">Copy</code>. Paste this password somewhere safe‚Äîit will only be generated this once!</li>
  <li>Go to Settings &gt; API Keys, show the Private API Key and copy it somewhere safe.</li>
</ol>

<h3 id="3-deploy-ghost-and-caddy">3. Deploy Ghost and Caddy</h3>

<h4 id="set-up-vm">Set up VM</h4>
<ol>
  <li>Go back to GCP &gt; Compute Engine &gt; VM Instances &gt; ghost-blog &gt; <code class="language-plaintext highlighter-rouge">SSH</code>. A virtual terminal (‚Äúcloud shell‚Äù) will appear in a pop-up window.</li>
  <li>
    <p>First, set a password for the root user:</p>

    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>passwd
</code></pre></div>    </div>
  </li>
  <li>Switch to root user:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> su
</code></pre></div>    </div>
  </li>
  <li>Update Linux:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> apt update
 apt upgrade
</code></pre></div>    </div>
  </li>
</ol>

<h4 id="install-docker">Install Docker</h4>
<ol>
  <li>Install dependencies:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> apt <span class="nb">install </span>apt-transport-https ca-certificates curl software-properties-common
</code></pre></div>    </div>
  </li>
  <li>Get Docker GPG key:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>apt-key add -
</code></pre></div>    </div>
  </li>
  <li>Download Docker:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>add-apt-repository <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"</span>
</code></pre></div>    </div>
  </li>
  <li>Install Docker:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>apt update
 <span class="nb">sudo </span>apt-cache policy docker-ce
 <span class="nb">sudo </span>apt <span class="nb">install </span>docker-ce
</code></pre></div>    </div>
  </li>
  <li>Make a new sudo-eligible user called <code class="language-plaintext highlighter-rouge">service_account</code>:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> adduser service_account
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set a password for <code class="language-plaintext highlighter-rouge">service_account</code>. Leave the ‚Äúuser information‚Äù for <code class="language-plaintext highlighter-rouge">service_account</code> at default values, and confirm with <code class="language-plaintext highlighter-rouge">Y</code>.</p>
  </li>
  <li>Give <code class="language-plaintext highlighter-rouge">service_account</code> sudo privileges:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> usermod <span class="nt">-aG</span> <span class="nb">sudo </span>service_account
</code></pre></div>    </div>
  </li>
  <li>
    <p>Close this cloud shell window and open a new one.</p>
  </li>
  <li>Switch to <code class="language-plaintext highlighter-rouge">service_account</code>:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> su - service_account
</code></pre></div>    </div>
  </li>
  <li>Allow <code class="language-plaintext highlighter-rouge">service_account</code> to use Docker:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker service_account
</code></pre></div>    </div>
  </li>
  <li>
    <p>Close this cloud shell window and open a new one.</p>
  </li>
  <li>Verify that Docker works by running:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>docker run hello-world
</code></pre></div>    </div>
  </li>
  <li>Set Mailgun SMTP credentials as environment variables. First open the bash profile in Vim:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>vi .profile
</code></pre></div>    </div>
  </li>
  <li>Vim has two modes, ‚ÄúCommand Mode‚Äù (file is read-only) and ‚ÄúInsert Mode‚Äù (file is editable). Press <code class="language-plaintext highlighter-rouge">I</code> to enter Insert Mode. Add these lines at the bottom of the file, replacing the fields with the Mailgun SMTP credentials you obtained:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">mail__options__auth__user</span><span class="o">=</span><span class="s2">"postmaster@ghostblog.com"</span>
<span class="nb">export </span><span class="nv">mail__options__auth__pass</span><span class="o">=</span><span class="s2">"theSMTPpasswordyoucopied"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Press <code class="language-plaintext highlighter-rouge">Esc</code> to return to ‚ÄúCommand Mode‚Äù. Type <code class="language-plaintext highlighter-rouge">:wq</code> to save and quit, then press <code class="language-plaintext highlighter-rouge">Enter</code>.</p>
  </li>
  <li>Update the profile with:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="nb">source</span> .profile
</code></pre></div>    </div>
  </li>
  <li>Close this cloud shell window and open a new one.</li>
</ol>

<h4 id="install-ghost-and-caddy">Install Ghost and Caddy</h4>

<ol>
  <li>Switch to <code class="language-plaintext highlighter-rouge">service_account</code>:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> su - service_account
</code></pre></div>    </div>
  </li>
  <li>Make a new directory called <code class="language-plaintext highlighter-rouge">ghost</code> and navigate to it:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="nb">mkdir</span> /home/service_account/ghost
 <span class="nb">cd </span>ghost
</code></pre></div>    </div>
  </li>
  <li>If you chose to run Mailgun from the EU, replace <code class="language-plaintext highlighter-rouge">smtp.mailgun.org</code> with <code class="language-plaintext highlighter-rouge">smtp.eu.mailgun.org</code>. Other than that, run the below command as is. This will download, configure, and run a Ghost image within Docker:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> docker run <span class="nt">-d</span> <span class="se">\</span>
 <span class="nt">--restart</span> always <span class="se">\</span>
 <span class="nt">--name</span> ghost-blog <span class="se">\</span>
 <span class="nt">-v</span> /home/service_account/ghost/content:/var/lib/ghost/content <span class="se">\</span>
 <span class="nt">-p</span> 2368:2368 <span class="se">\</span>
 <span class="nt">-e</span> <span class="nv">url</span><span class="o">=</span>https://ghostblog.com <span class="se">\</span>
 <span class="nt">-e</span> <span class="nv">mail__transport</span><span class="o">=</span><span class="s2">"SMTP"</span> <span class="se">\</span>
 <span class="nt">-e</span> <span class="nv">mail__options__host</span><span class="o">=</span><span class="s2">"smtp.mailgun.org"</span> <span class="se">\</span>
 <span class="nt">-e</span> <span class="nv">mail__options__port</span><span class="o">=</span>2525 <span class="se">\</span>
 <span class="nt">-e</span> mail__options__auth__user <span class="se">\</span>
 <span class="nt">-e</span> mail__options__auth__pass <span class="se">\</span>
 ghost
</code></pre></div>    </div>
  </li>
  <li>Run the command below and note the ‚ÄúContainer ID‚Äù associated with the ‚Äúghost‚Äù Image:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> docker ps
</code></pre></div>    </div>
  </li>
  <li>Run the command below, replacing <code class="language-plaintext highlighter-rouge">containerid</code> with yours. Verify that the environment variables (the <code class="language-plaintext highlighter-rouge">docker run</code> fields tagged with <code class="language-plaintext highlighter-rouge">-e</code>) were saved.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> docker <span class="nb">exec </span>containerid <span class="nb">printenv</span>
</code></pre></div>    </div>
  </li>
  <li>Create a Caddyfile to store the configuration for the Caddy web server:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> vi Caddyfile
</code></pre></div>    </div>
  </li>
  <li>In the text below, replace <code class="language-plaintext highlighter-rouge">your@email.com</code> with your own email. (Caddy uses your email address to procure free SSL certificates from <a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let‚Äôs Encrypt</a>.) Press <code class="language-plaintext highlighter-rouge">I</code> to enter Insert Mode. <strong>Type out</strong> the following text in Vim directly, using <strong>tabs</strong> to indent lines:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> https://ghostblog.com <span class="o">{</span>
     proxy / ghost-blog:2368 <span class="o">{</span>
         transparent
     <span class="o">}</span>
     tls your@email.com
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Press <code class="language-plaintext highlighter-rouge">Esc</code> to return to ‚ÄúCommand Mode‚Äù. Type <code class="language-plaintext highlighter-rouge">:wq</code> to save and quit, then press <code class="language-plaintext highlighter-rouge">Enter</code>.</p>
  </li>
  <li>Install Caddy, keying in <code class="language-plaintext highlighter-rouge">Y</code> when prompted:
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> docker run <span class="nt">-it</span> <span class="se">\</span>
 <span class="nt">--restart</span> always <span class="se">\</span>
 <span class="nt">--link</span> ghost-blog:ghost-blog <span class="se">\</span>
 <span class="nt">--name</span> caddy <span class="se">\</span>
 <span class="nt">-p</span> 80:80 <span class="se">\</span>
 <span class="nt">-p</span> 443:443 <span class="se">\</span>
 <span class="nt">-v</span> /home/service_account/ghost/Caddyfile:/etc/Caddyfile <span class="se">\</span>
 <span class="nt">-v</span> /home/service_account/.caddy:/root/.caddy <span class="se">\</span>
 abiosoft/caddy
</code></pre></div>    </div>
  </li>
  <li>Try to visit your domain <code class="language-plaintext highlighter-rouge">https://ghostblog.com</code>. Sometimes you might need to go back to Cloudflare and <code class="language-plaintext highlighter-rouge">Pause Cloudflare on this site</code> for a while. Once the webpage connects and displays the default Ghost template, close the cloud shell window. Installation is complete!</li>
</ol>

<h3 id="4-configure-ghost">4. Configure Ghost</h3>
<ol>
  <li>Go to <code class="language-plaintext highlighter-rouge">https://ghostblog.com/ghost</code>. Set up your website basic details.</li>
  <li>Go to Settings (the ‚Äúgear‚Äù icon) &gt; Email newsletter &gt; Email newsletter settings:
    <ul>
      <li>Mailgun region: whichever you selected previously</li>
      <li>Mailgun domain: ghostblog.com</li>
      <li>Mailgun Private API key: the Private API key you took note of</li>
    </ul>
  </li>
  <li>Turn <code class="language-plaintext highlighter-rouge">off</code> ‚ÄúEnable newsletter open-rate analytics‚Äù.</li>
  <li>
<code class="language-plaintext highlighter-rouge">Save Settings</code>.</li>
  <li>
<em>(Optional)</em> To disable the hovering ‚ÄúSubscribe‚Äù button, go to Membership &gt; <code class="language-plaintext highlighter-rouge">Customize Portal</code> and disable ‚ÄúShow Portal Button.‚Äù</li>
</ol>

<h3 id="5-finish-cloudflare-configuration">5. Finish Cloudflare Configuration</h3>
<ol>
  <li>Go back to Cloudflare. If you had previously <code class="language-plaintext highlighter-rouge">Paused</code> Cloudflare, go back to Advanced Actions &gt; <code class="language-plaintext highlighter-rouge">Enable Cloudflare on site</code>.</li>
  <li>Go to ghostblog.com &gt; DNS &gt; <code class="language-plaintext highlighter-rouge">Add record</code>:
    <ul>
      <li>Type: <code class="language-plaintext highlighter-rouge">A</code>
</li>
      <li>Name: <code class="language-plaintext highlighter-rouge">www.ghostblog.com</code>
</li>
      <li>IPv4 address: your GCP external IP address</li>
      <li>Proxy status: <code class="language-plaintext highlighter-rouge">Proxied</code>
</li>
    </ul>
  </li>
  <li>
<code class="language-plaintext highlighter-rouge">Edit</code> the other A record to change Proxy status to <code class="language-plaintext highlighter-rouge">Proxied</code>.</li>
  <li>Go to ghostblog.com &gt; SSL/TLS &gt; Overview and change SSL/TLS encryption mode to <code class="language-plaintext highlighter-rouge">Full</code>.</li>
</ol>

<h2 id="congratulations">Congratulations!</h2>
<p>At this point you should have a working self-hosted Ghost blog. The technical setup is over‚Äîfrom now on, you should be working within the <code class="language-plaintext highlighter-rouge">https://ghostblog.com/ghost</code> control panel instead.</p>

<h3 id="contribute">Contribute</h3>
<p>This walkthrough last worked for me in January 2022. If you spot errors, vulnerabilities, or potential improvements, please do <a href="https://github.com/scottleechua/scottleechua.github.io/blob/source/_posts/2022-01-21-self-hosting-ghost-on-gcp.md" target="_blank" rel="noopener">open a pull request</a> on this blog post!</p>

<h3 id="acknowledgements">Acknowledgements</h3>
<p>This tutorial owes a debt of gratitude to The Applied Architect‚Äôs <a href="https://theappliedarchitect.com/setup-a-free-self-hosted-blog-in-under-15-minutes/" target="_blank" rel="noopener">Ghost on GCP tutorial</a> and Brian Burroughs‚Äô <a href="https://techroads.org/building-a-caddy-container-stack-for-easy-https-with-docker-and-ghost/" target="_blank" rel="noopener">Ghost + Caddy tutorial</a>, which helped me piece together the deployment process in Step 3.</p>

  </article>

</div>

    </div>

    <!-- Footer -->

    <footer class="sticky-bottom mt-5">
  <div class="container">
    ¬© 2023 Scott Lee Chua.
    Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener">al-folio</a> theme. Read the <a href="/privacy/">Privacy Policy</a>.

    
    
  </div>
</footer>

  <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

  <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

  <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
  <!-- Load Common JS -->
<script src="/assets/js/common.js"></script>

  

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">

    <!-- The loading of KaTeX is deferred to speed up page rendering -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>

    <!-- To automatically render math in text elements, include the auto-render extension: -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
        

  <script defer data-domain="scottleechua.com" src="https://plausible.io/js/plausible.js"></script>

  </body>
</html>
